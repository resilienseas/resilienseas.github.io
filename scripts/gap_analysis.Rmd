---
title: "Ocean Acidification Monitoring Inventory Gap Analysis"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
  
##Step 1. Manipulate sea surface temperature and dissolved oxygen as proxies for ocean acidificiation change
####Load packages
```{r packages, message = FALSE, warning = FALSE, results = 'hide'}

if (!require(pacman)) install.packages("pacman")
library(pacman)
p_load(
  tidyverse, here, glue,
  raster,
  sdmpredictors, dismo, 
  deldir, 
  mapview,
  tmap)

devtools::load_all(here("../oatools"))

```

####Set paths and variables
```{r paths, message = FALSE, warning = FALSE, results = 'hide'}

dir_data        <- here("data")
dir_sdmdata_old <- here("data/sdmpredictors")
dir_cache       <- here("cache")
dir_sdmdata     <- here("cache/sdmpredictors")

SST_tif <- here("data/sst_mean.tif")
DO_tif  <- here("data/do_mean.tif")

```
  
####Set cache
```{r cache, message = FALSE, warning = FALSE, results = 'hide'}

if (!dir.exists(dir_data))    dir.create(dir_data)
if (!dir.exists(dir_cache))   dir.create(dir_cache)
if (!dir.exists(dir_sdmdata) & dir.exists(dir_sdmdata_old))
  file.rename(dir_sdmdata_old, dir_sdmdata)
if (!dir.exists(dir_sdmdata)) dir.create(dir_sdmdata)

```
  
####Set extent and coordinate reference system
```{r extent, message = FALSE, warning = FALSE, results = 'hide'}

ext_study <- extent(-670000, 350000, -885000, 1400000)
crs_study <- '+init=EPSG:6414'

```
  
####Create sea surface temperature layer (mean and range)
```{r sst, message = FALSE, warning = FALSE, results = 'hide'}

r_sst_mean_nofill <- lyr_to_tif(
  lyr = "BO_sstmean", 
  tif = here("data/sst_mean.tif"),
  crs = crs_study,
  dir_sdm_cache = dir_sdmdata,
  extent_crop   = ext_study, 
  redo=T, fill_na=FALSE)

r_sst_mean <- lyr_to_tif(
  lyr = "BO_sstmean", 
  tif = here("data/sst_mean.tif"),
  crs = crs_study,
  dir_sdm_cache = dir_sdmdata,
  extent_crop   = ext_study, 
  redo=T, fill_na=TRUE, fill_window=11) #caclulate mean

n_na_nofill <- sum(is.na(raster::getValues(r_sst_mean_nofill)))
n_na        <- sum(is.na(raster::getValues(r_sst_mean)))

r_sst_range_nofill <- lyr_to_tif(
  lyr = "BO_sstrange", 
  tif = here("data/sst_range.tif"),
  crs = crs_study,
  dir_sdm_cache = dir_sdmdata,
  extent_crop   = ext_study, 
  redo=T, fill_na=FALSE)

r_sst_range <- lyr_to_tif(
  lyr = "BO_sstrange", 
  tif = here("data/sst_range.tif"),
  crs = crs_study,
  dir_sdm_cache = dir_sdmdata,
  extent_crop   = ext_study, 
  redo=T, fill_na=TRUE, fill_window=11)

```
  
####Create dissolved oxygen layer (mean and range)
```{r do, message = FALSE, warning = FALSE, results = 'hide'}
r_do_mean_nofill <- lyr_to_tif(
  lyr = "BO_dissox", 
  tif = here("data/do_mean.tif"),
  crs = crs_study,
  dir_sdm_cache = dir_sdmdata,
  extent_crop   = ext_study, 
  redo=T, fill_na=FALSE)

r_do_mean <- lyr_to_tif(
  lyr = "BO_dissox", 
  tif = here("data/do_mean.tif"),
  crs = crs_study,
  dir_sdm_cache = dir_sdmdata,
  extent_crop   = ext_study, 
  redo=T, fill_na=TRUE, fill_window=11) #calculate mean

r_do_range_nofill <- lyr_to_tif(
  lyr = "BO2_dissoxrange_bdmin", 
  tif = here("data/do_range.tif"),
  crs = crs_study,
  dir_sdm_cache = dir_sdmdata,
  extent_crop   = ext_study, 
  redo=T, fill_na=FALSE)

r_do_range <- lyr_to_tif(
  lyr = "BO2_dissoxrange_bdmin", 
  tif = here("data/do_range.tif"),
  crs = crs_study,
  dir_sdm_cache = dir_sdmdata,
  extent_crop   = ext_study, 
  redo=T, fill_na=TRUE, fill_window=11)

```
  
##Step 2. Relate SST and DO trends to each monitoring site
####Load monitoring inventory
```{r inventory, message = FALSE, warning = FALSE, results = 'hide'}

oahfocus <- read_csv(here("data/oahfocus.csv"))

```
####Tidy Inventory
1. Isolate OAH Focus Data Collection
2. Quantify Data Collection Frequency (measurements/year)
3. Remove NA coordinate entries from gliders
4. Transform latitude and longitude to numeric
5. Create subsets of data

```{r}
oahfocus <- subset(inventory, OAHFocus == "OA" | OAHFocus == "H" | OAHFocus == "OAH") #remove non OAH focus entries

oahfocus$MeasFreq[oahfocus$MeasFreq =="Once"] <- 0
oahfocus$MeasFreq[oahfocus$MeasFreq == 10] <- 52560
oahfocus$MeasFreq[oahfocus$MeasFreq =="< 6 hours"] <- 1460
oahfocus$MeasFreq[oahfocus$MeasFreq == 60] <- 8760
oahfocus$MeasFreq[oahfocus$MeasFreq =="Daily"] <- 365
oahfocus$MeasFreq[oahfocus$MeasFreq ==30] <- 17520
oahfocus$MeasFreq[oahfocus$MeasFreq == 20] <- 26280
oahfocus$MeasFreq[oahfocus$MeasFreq == 15] <- 35040
oahfocus$MeasFreq[oahfocus$MeasFreq =="Quarterly"] <- 4
oahfocus$MeasFreq[oahfocus$MeasFreq =="Annual"] <- 1
oahfocus$MeasFreq[oahfocus$MeasFreq =="Monthly"] <- 12
oahfocus$MeasFreq[oahfocus$MeasFreq == 5] <- 105120
oahfocus$MeasFreq[oahfocus$MeasFreq == 6] <- 87600
oahfocus$MeasFreq[oahfocus$MeasFreq =="Semi-annual"] <- 2
oahfocus$MeasFreq[oahfocus$MeasFreq == 180] <- 2920
oahfocus$MeasFreq[oahfocus$MeasFreq == 2] <- 262800
oahfocus$MeasFreq[oahfocus$MeasFreq == 0.25] <- 2102400
oahfocus$MeasFreq[oahfocus$MeasFreq == 3] <- 175200
oahfocus$MeasFreq[oahfocus$MeasFreq == 1] <- 525600
oahfocus$MeasFreq[oahfocus$MeasFreq == 120] <- 2920
oahfocus$MeasFreq[oahfocus$MeasFreq =="Bi-weekly"] <- 26
oahfocus$MeasFreq[oahfocus$MeasFreq == 360] <- 1460
oahfocus$MeasFreq[oahfocus$MeasFreq == 720] <- 730
oahfocus$MeasFreq[oahfocus$MeasFreq =="Seasonally"] <- 1
oahfocus$MeasFreq[oahfocus$MeasFreq =="1/4 second"] <- 126144000
oahfocus$MeasFreq[oahfocus$MeasFreq =="Bi-monthly"] <- 6
oahfocus$MeasFreq[oahfocus$MeasFreq =="5  Years"] <- 0.2
oahfocus$MeasFreq[oahfocus$MeasFreq =="Bi-weekly"] <- 26
oahfocus$MeasFreq[oahfocus$MeasFreq =="Variable"] <- 0
oahfocus$MeasFreq[oahfocus$MeasFreq =="Decadal"] <- 0.1
oahfocus$MeasFreq[oahfocus$MeasFreq =="Biennial"] <- 0.5
oahfocus$MeasFreq[oahfocus$MeasFreq =="Weekly"] <- 52
oahfocus$MeasFreq[oahfocus$MeasFreq =="Triennial"] <- 0.33333
oahfocus$MeasFreq[oahfocus$MeasFreq =="Trimester"] <- 3
#quantify frequencies

unique(oahfocus$MeasFreq)
#check to make sure all frequencies were quantified

oahfocus <- oahfocus[!is.na(oahfocus$Latitude), ]
oahfocus <- oahfocus[!is.na(oahfocus$Longitude), ]
#remove NA coordinates

gsub(" ", "", oahfocus$Latitude)
gsub(" ", "", oahfocus$Longitude)
gsub("'<ca>'", "", oahfocus$Longitude)
oahfocus$Longitude<-as.numeric(oahfocus$Longitude)
oahfocus$Latitude<-as.numeric(oahfocus$Latitude)
#remove spaces and transform to numeric

carbcomplete<-subset(oahfocus, DisCrbPmtr>1 | ISCrbPmtr > 1)
incomplete <- subset(oahfocus, DisCrbPmtr<2 & ISCrbPmtr < 2)
highfrequency<-subset(oahfocus, MeasFreq > 364)
highfreqcarbcomplete<-subset(oahfocus, MeasFreq > 364 & DisCrbPmtr>1 | MeasFreq > 364 & ISCrbPmtr > 1)
lowfrequency <- subset(oahfocus, MeasFreq < 365)
#subset data

```

  
####Transform into spatial data
```{r inventory spatial, message = FALSE, warning = FALSE, results = 'hide'}

coords <- cbind.data.frame(oahfocus$Longitude, oahfocus$Latitude) #isolate coordinate columns

deduped.coords<-unique(coords) # remove duplicate locations

inventorycoords <- SpatialPoints(deduped.coords, CRS("+proj=longlat +ellps=WGS84"))
inventorycoords <- spTransform(inventorycoords, CRS('+init=EPSG:6414')) # create spatial points objects

# isolate coordinate columns
coords <- cbind.data.frame(oahfocus$Longitude, oahfocus$Latitude)
carbcompletecoords <- cbind.data.frame(carbcomplete$Longitude, carbcomplete$Latitude)
incompletecoords <- cbind.data.frame(incomplete$Longitude, incomplete$Latitude)
highfrequencycoords <- cbind.data.frame(highfrequency$Longitude, highfrequency$Latitude)
lowfrequencycoords <- cbind.data.frame(lowfrequency$Longitude, lowfrequency$Latitude)
highfreqcarbcompletecoords <- cbind.data.frame(highfreqcarbcomplete$Longitude, highfreqcarbcomplete$Latitude)

# remove duplicate locations
deduped.coords<-unique(coords)
deduped.carbcomplete <- unique(carbcompletecoords)
deduped.incomplete <- unique(incompletecoords)
deduped.highfrequency <- unique(highfrequencycoords)
deduped.lowfrequency <- unique(lowfrequencycoords)
deduped.highfreqcarbcomplete <- unique(highfreqcarbcompletecoords)

# create spatial points objects
inventorycoords <- SpatialPoints(deduped.coords, CRS("+proj=longlat +ellps=WGS84"))
inventorycoords <- spTransform(inventorycoords, CRS('+init=EPSG:6414'))

carbcompletecoords <- SpatialPoints(deduped.carbcomplete, CRS("+proj=longlat +ellps=WGS84"))
carbcompletecoords <- spTransform(carbcompletecoords, CRS('+init=EPSG:6414'))

incompletecoords <- SpatialPoints(deduped.incomplete, CRS("+proj=longlat +ellps=WGS84"))
incompletecoords <- spTransform(incompletecoords, CRS('+init=EPSG:6414'))

highfreqcoords <- SpatialPoints(deduped.highfrequency, CRS("+proj=longlat +ellps=WGS84"))
highfreqcoords <- spTransform(highfreqcoords, CRS('+init=EPSG:6414'))

lowfreqcoords <- SpatialPoints(deduped.lowfrequency, CRS("+proj=longlat +ellps=WGS84"))
lowfreqcoords <- spTransform(lowfreqcoords, CRS('+init=EPSG:6414'))



```
  
####Create voronoi polygons
```{r voronoi, message = FALSE, warning = FALSE, results = 'hide'}

vor <-voronoi(inventorycoords)

vorraster<- rasterize(vor, r_sst_mean, "id") #rasterize

```
  
####Extract SST mean and range for each monitoring site cell and substitute value for each voronoi polygon
```{r extract and replace sst, message = FALSE, warning = FALSE, results = 'hide'}

sitesst<- raster::extract(r_sst_mean, inventorycoords, method='simple', df=TRUE)
colnames(sitesst)<-c("id", "SST") #rename column names of sitesst
polygonsst <- subs(vorraster, sitesst, by="id", which="SST", subsWithNA=FALSE) #substitute polygon id for monitoring site sea surface temerature of that polygon

sitesstrange<- raster::extract(r_sst_range, inventorycoords, method='simple', df=TRUE)
colnames(sitesstrange)<-c("id", "SSTrange") #rename column names of sitesstrange
polygonsstrange<-subs(vorraster, sitesstrange, by="id", which="SSTrange", subsWithNA=FALSE) #substitute polygon id for monitoring site sea surface temerature range of that polygon

```
  
####Repeat with DO
```{r extract and replace do, message = FALSE, warning = FALSE, results = 'hide'}

sitedo<- raster::extract(r_do_mean, inventorycoords, method='simple', df=TRUE)
colnames(sitedo)<-c("id", "DO") #rename column names of sitedo
polygondo<-subs(vorraster, sitedo, by="id", which="DO")

sitedorange<- raster::extract(r_do_range, inventorycoords, method='simple', df=TRUE)
colnames(sitedorange)<-c("id", "DOrange")
polygondorange<-subs(vorraster, sitedorange, by="id", which="DOrange")

```
  
##Step 3. Create "oceanographic variability" layer relative to monitoring asset
To account for variation in both SST and DO as a combined proxy for ocean acidification variability, we use the following formula:
variation = (imean - amean) + (imean - amean)*(irange - arange)
where i = cell in raster of study area and a = cell containing nearest monitoring site
```{r calculate variability, message = FALSE, warning = FALSE, results = 'hide'}

sstmeandiff <- abs(r_sst_mean_nofill - polygonsst) #difference between sst at each point and sst for area associated with closest monitoring site
sstrangediff <- abs(r_sst_range_nofill - polygonsstrange) #difference between sst range at each point and sst range for area associated with closest monitoring site 
sstvariation <- sstmeandiff+(sstmeandiff*sstrangediff)

domeandiff <- abs(r_do_mean_nofill - polygondo) #difference between DO at each point and DO for area associated with closest monitoring site
dorangediff <- abs(r_do_range_nofill - polygondorange) #difference between DO range at each point and DO range for area associated with closest monitoring site
dovariation <- domeandiff + (domeandiff*dorangediff)

variation <- (sstvariation*dovariation) #total variation

```
  
##Step 4. Identify gaps
####Identify gaps based on distance between monitoring points, qualified by strength of variability
```{r gaps, message = FALSE, warning = FALSE, results = 'hide'}

distance<-distanceFromPoints(variation,inventorycoords)
gaps <- setValues(distance, log10(getValues(distance)*(getValues(variation))))

```

####Visualize gaps along the West Coast
```{r west coast, message = FALSE, warning = FALSE, results = 'hide'}

poly_coast<- readOGR(dsn=path.expand("/Users/Madi/Documents/UCSB Bren/ResilienSeas/Export_Output_2"), layer="Export_Output_2")
poly_coast <- spTransform(poly_coast, crs(gaps))
gaps_clipped <- mask(gaps, poly_coast, inverse = TRUE,progress='text')

```

